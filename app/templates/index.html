<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy Integration Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0047BB;
            --secondary-color: #3F88F6;
            --light-bg: #F4F6F9;
        }
        body {
            background-color: var(--light-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .integration-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .integration-card:hover {
            transform: translateY(-5px);
        }
        .integration-logo {
            max-width: 100px;
            max-height: 100px;
            margin: 20px 0;
        }
        .step-container {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .progress {
            height: 5px;
            margin-bottom: 20px;
        }
        .select2-container {
            width: 100% !important;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1>Alchemy Integration Manager</h1>
                <p class="text-muted">Connect Alchemy to your favorite enterprise platforms</p>
            </div>
        </div>

        <div class="row" id="platformSelectionStep">
            <div class="col-md-4">
                <div class="integration-card text-center p-4" data-platform="sap">
                    <img src="/static/sap-logo.png" alt="SAP Logo" class="integration-logo">
                    <h4>SAP</h4>
                    <p class="text-muted">Enterprise Resource Planning</p>
                    <button class="btn btn-primary select-platform">Select SAP</button>
                </div>
            </div>
            <div class="integration-card text-center p-4" data-platform="salesforce">
                <img src="/static/salesforce-logo.png" alt="Salesforce Logo" class="integration-logo">
                <h4>Salesforce</h4>
                <p class="text-muted">Customer Relationship Management</p>
                <button class="btn btn-primary select-platform">Select Salesforce</button>
            </div>
            <div class="integration-card text-center p-4" data-platform="hubspot">
                <img src="/static/hubspot-logo.png" alt="HubSpot Logo" class="integration-logo">
                <h4>HubSpot</h4>
                <p class="text-muted">Marketing Automation</p>
                <button class="btn btn-primary select-platform">Select HubSpot</button>
            </div>
        </div>

        <div id="integrationConfigStep" style="display:none;">
            <div class="row">
                <div class="col-12">
                    <div class="step-container">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 33%"></div>
                        </div>
                        
                        <h3 id="selectedPlatformTitle">Configure Integration</h3>
                        
                        <form id="integrationConfigForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <h4>Alchemy Connection</h4>
                                    <div class="mb-3">
                                        <label class="form-label">Tenant</label>
                                        <select id="alchemyTenant" class="form-select">
                                            <option value="">Select Alchemy Tenant</option>
                                            <!-- Dynamically populated -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Authentication Method</label>
                                        <select id="alchemyAuthMethod" class="form-select">
                                            <option value="oauth">OAuth</option>
                                            <option value="token">Refresh Token</option>
                                        </select>
                                    </div>
                                    <div id="alchemyOAuthSection">
                                        <div class="mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" id="alchemyEmail">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Password</label>
                                            <input type="password" class="form-control" id="alchemyPassword">
                                        </div>
                                    </div>
                                    <div id="alchemyTokenSection" style="display:none;">
<div class="mb-3" id="alchemyRecordTypeSection" style="display:none;">
    <label class="form-label">Record Type</label>
    <select id="alchemyRecordType" class="form-select">
        <option value="">Select Record Type</option>
    </select>
</div>

                                        <div class="mb-3">
                                            <label class="form-label">Refresh Token</label>
                                            <input type="text" class="form-control" id="alchemyRefreshToken">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h4 id="targetPlatformTitle">Platform Connection</h4>
                                    <div id="sapConnectionFields" style="display:none;">
                                        <div class="mb-3">
                                            <label class="form-label">SAP Base URL</label>
                                            <input type="text" class="form-control" id="sapBaseUrl">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Client ID</label>
                                            <input type="text" class="form-control" id="sapClientId">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Client Secret</label>
                                            <input type="password" class="form-control" id="sapClientSecret">
                                        </div>
                                    </div>
                                    
                                    <div id="salesforceConnectionFields" style="display:none;">
                                        <div class="mb-3">
                                            <label class="form-label">Salesforce Instance URL</label>
                                            <input type="text" class="form-control" id="salesforceInstanceUrl">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Consumer Key</label>
                                            <input type="text" class="form-control" id="salesforceConsumerKey">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Consumer Secret</label>
                                            <input type="password" class="form-control" id="salesforceConsumerSecret">
                                        </div>
                                    </div>
                                    
                                    <div id="hubspotConnectionFields" style="display:none;">
                                        <div class="mb-3">
                                            <label class="form-label">HubSpot Access Token</label>
                                            <input type="text" class="form-control" id="hubspotAccessToken">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">HubSpot Hub ID</label>
                                            <input type="text" class="form-control" id="hubspotHubId">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Field Mapping</h4>
                                    <div id="fieldMappingContainer">
                                        <div class="row mb-3">
                                            <div class="col-5">
                                                <label class="form-label">Alchemy Field</label>
                                                <select class="form-select alchemy-field-select">
                                                    <option value="">Select Alchemy Field</option>
                                                </select>
                                            </div>
                                            <div class="col-5">
                                                <label class="form-label">Target Field</label>
                                                <select class="form-select target-field-select">
                                                    <option value="">Select Target Field</option>
                                                </select>
                                            </div>
                                            <div class="col-2">
                                                <label class="form-label">Action</label>
                                                <button class="btn btn-success add-mapping-btn">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="mappedFieldsContainer"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary" id="backToPlatformSelection">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-primary" id="saveIntegrationConfig">
                                            Save Configuration
                                            <i class="fas fa-save ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Integration Configured Successfully</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Your integration has been saved and is ready to use.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        $(document).ready(function() {
            let selectedPlatform = null;

            // Platform Selection
            $('.select-platform').on('click', function() {
                selectedPlatform = $(this).closest('.integration-card').data('platform');
                
                // Hide platform selection
                $('#platformSelectionStep').hide();
                
                // Show integration config step
                $('#integrationConfigStep').show();
                
                // Update title and show relevant connection fields
                $('#selectedPlatformTitle').text(`Configure ${selectedPlatform.charAt(0).toUpperCase() + selectedPlatform.slice(1)} Integration`);
                
                // Hide all platform-specific connection fields
                $('#sapConnectionFields, #salesforceConnectionFields, #hubspotConnectionFields').hide();
                
                // Show selected platform's connection fields
                $(`#${selectedPlatform}ConnectionFields`).show();
            });

            // Back to Platform Selection
            $('#backToPlatformSelection').on('click', function() {
                $('#integrationConfigStep').hide();
                $('#platformSelectionStep').show();
            });

            // Alchemy Authentication Method Toggle
            $('#alchemyAuthMethod').on('change', function() {
                const method = $(this).val();
                if (method === 'oauth') {
                    $('#alchemyOAuthSection').show();
                    $('#alchemyTokenSection').hide();
                } else {
                    $('#alchemyOAuthSection').hide();
                    $('#alchemyTokenSection').show();
                }
            });

            // Dynamic Field Mapping
            $('.add-mapping-btn').on('click', function(e) {
                e.preventDefault();
                const newMapping = `
                    <div class="row mb-2 mapped-field">
                        <div class="col-5">
                            <select class="form-select alchemy-field">
                                <option value="">Alchemy Field</option>
                                <!-- Populate dynamically -->
                            </select>
                        </div>
                        <div class="col-5">
                            <select class="form-select target-field">
                                <option value="">Target Field</option>
                                <!-- Populate dynamically -->
                            </select>
                        </div>
                        <div class="col-2">
                            <button class="btn btn-danger remove-mapping-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                $('#mappedFieldsContainer').append(newMapping);
            });

            // Remove Mapping
            $(document).on('click', '.remove-mapping-btn', function() {
                $(this).closest('.mapped-field').remove();
            });

            // Save Integration Configuration
            $('#saveIntegrationConfig').on('click', function() {
                // Collect all configuration data
                const integrationConfig = {
                    platform: selectedPlatform,
                    alchemy: {
                        tenant: $('#alchemyTenant').val(),
                        authMethod: $('#alchemyAuthMethod').val(),
                        email: $('#alchemyEmail').val(),
                        password: $('#alchemyPassword').val(),
                        refreshToken: $('#alchemyRefreshToken').val()
                    },
                    platformConnection: {}
                };

                // Collect platform-specific connection details
                switch(selectedPlatform) {
                    case 'sap':
                        integrationConfig.platformConnection = {
                            baseUrl: $('#sapBaseUrl').val(),
                            clientId: $('#sapClientId').val(),
                            clientSecret: $('#sapClientSecret').val()
                        };
                        break;
                    case 'salesforce':
                        integrationConfig.platformConnection = {
                            instanceUrl: $('#salesforceInstanceUrl').val(),
                            consumerKey: $('#salesforceConsumerKey').val(),
                            consumerSecret: $('#salesforceConsumerSecret').val()
                        };
                        break;
                    case 'hubspot':
                        integrationConfig.platformConnection = {
                            accessToken: $('#hubspotAccessToken').val(),
                            hubId: $('#hubspotHubId').val()
                        };
                        break;
                }

                // Collect field mappings
                integrationConfig.fieldMappings = [];
                $('.mapped-field').each(function() {
                    const alchemyField = $(this).find('.alchemy-field').val();
                    const targetField = $(this).find('.target-field').val();
                    
                    if (alchemyField && targetField) {
                        integrationConfig.fieldMappings.push({
                            alchemyField: alchemyField,
                            targetField: targetField
                        });
                    }
                });

                // Send configuration to backend
                $.ajax({
                    url: '/save-integration-config',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(integrationConfig),
                    success: function(response) {
                        // Show success modal
                        const successModal = new bootstrap.Modal('#successModal');
                        successModal.show();
                    },
                    error: function(xhr, status, error) {
                        // Handle error
                        alert('Failed to save integration: ' + error);
                    }
                });
            });

            // Populate Alchemy Tenants (would be dynamically loaded)
            function loadAlchemyTenants() {
                $.ajax({
                    url: '/get-alchemy-tenants',
                    method: 'GET',
                    success: function(tenants) {
                        const tenantSelect = $('#alchemyTenant');
                        tenants.forEach(tenant => {
                            tenantSelect.append(
                                `<option value="${tenant.id}">${tenant.name}</option>`
                            );
                        });
                    }
                });
            }

            // Populate Field Selectors
            function loadFieldSelectors() {
                // Load Alchemy Fields
                $.ajax({
                    url: '/get-alchemy-fields',
                    method: 'GET',
                    success: function(fields) {
                        const alchemyFieldSelects = $('.alchemy-field-select, .alchemy-field');
                        fields.forEach(field => {
                            alchemyFieldSelects.append(
                                `<option value="${field.identifier}">${field.name}</option>`
                            );
                        });
                    }
                });

                // Load Target Platform Fields
                function loadTargetFields(platform) {
                    $.ajax({
                        url: `/get-${platform}-fields`,
                        method: 'GET',
                        success: function(fields) {
                            const targetFieldSelects = $('.target-field-select, .target-field');
                            targetFieldSelects.empty().append('<option value="">Select Target Field</option>');
                            fields.forEach(field => {
                                targetFieldSelects.append(
                                    `<option value="${field.identifier}">${field.name}</option>`
                                );
                            });
                        }
                    });
                }

                // Update target fields when platform changes
                $(document).on('change', '.alchemy-field-select', function() {
                    if (selectedPlatform) {
                        loadTargetFields(selectedPlatform);
                    }
                });
            }

            // Initialize
            loadAlchemyTenants();
            loadFieldSelectors();

            $('#alchemyTenant, #alchemyRefreshToken').on('change', function() {
                const tenant = $('#alchemyTenant').val();
                const refreshToken = $('#alchemyRefreshToken').val();
                if (tenant && refreshToken) {
                    loadAlchemyRecordTypes(tenant, refreshToken);
                }
            });

            $('#alchemyRecordType').on('change', function() {
                const tenant = $('#alchemyTenant').val();
                const refreshToken = $('#alchemyRefreshToken').val();
                const recordType = $(this).val();
                if (tenant && refreshToken && recordType) {
                    loadAlchemyFields(tenant, refreshToken, recordType);
                }
            });

            function loadAlchemyRecordTypes(tenant, refreshToken) {
                $.ajax({
                    url: '/get-alchemy-record-types',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenant, refresh_token: refreshToken }),
                    success: function(recordTypes) {
                        const recordTypeSelect = $('#alchemyRecordType');
                        recordTypeSelect.empty().append('<option value="">Select Record Type</option>');
                        recordTypes.forEach(rt => {
                            recordTypeSelect.append(`<option value="${rt.identifier}">${rt.name}</option>`);
                        });
                        $('#alchemyRecordTypeSection').show();
                    },
                    error: function(err) {
                        alert('Error loading record types from Alchemy');
                        console.error(err);
                    }
                });
            }

            function loadAlchemyFields(tenant, refreshToken, recordType) {
                $.ajax({
                    url: '/get-alchemy-fields',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenant, refresh_token: refreshToken, record_type: recordType }),
                    success: function(fields) {
                        const alchemyFieldSelects = $('.alchemy-field-select, .alchemy-field');
                        alchemyFieldSelects.empty().append('<option value="">Select Alchemy Field</option>');
                        fields.forEach(field => {
                            alchemyFieldSelects.append(`<option value="${field.identifier}">${field.name}</option>`);
                        });
                    },
                    error: function(err) {
                        alert('Error loading Alchemy fields');
                        console.error(err);
                    }
                });
            }

        });
    </script>
</body>
</html>
